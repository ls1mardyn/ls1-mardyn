<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ls1-MarDyn: src/utils/AlignedArray.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ls1-MarDyn
   </div>
   <div id="projectbrief">ls1-MarDyn molecular dynamics code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_313caf1132e152dd9b58bea13a4052ca.html">utils</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle"><div class="title">AlignedArray.h</div></div>
</div><!--header-->
<div class="contents">
<a href="AlignedArray_8h.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span> </div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="preprocessor">#ifndef ALIGNEDARRAY_H_</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor">#define ALIGNEDARRAY_H_</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span> </div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="preprocessor">#ifdef __SSE3__</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor">#include &lt;xmmintrin.h&gt;</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="preprocessor">#include &lt;malloc.h&gt;</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="preprocessor">#include &lt;new&gt;</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="preprocessor">#include &lt;cstring&gt;</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="preprocessor">#include &quot;utils/mardyn_assert.h&quot;</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="preprocessor">#include &quot;AlignedAllocator.h&quot;</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span> </div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="preprocessor">#define CACHE_LINE_SIZE 64</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span> </div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="comment">// TODO: managing this class is becoming too complicated</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span><span class="comment">// mainly because of the need to remember what happens when,</span></div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="comment">// since our functions don&#39;t follow standard naming rules</span></div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="comment">// and conventions stemming from std::vector.</span></div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span><span class="comment">//</span></div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="comment">// Switch to std::vector with a custom allocator</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span><span class="comment">// so that it is at least clear what happens when.</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="comment">//</span></div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span><span class="comment">// Regarding prefetching on Xeon Phi, consider the following text, coming from here:</span></div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="comment">// https://tianyuliukingcrimson.wordpress.com/2015/07/01/prefetch-on-intel-mic-coprocessor-and-xeon-cpu/</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>    <span class="comment">//Prefetch instruction</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>    <span class="comment">//Let’s take a look at two orthogonal concepts first:</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    <span class="comment">//    non-temporal hint (NTA) — informs that data will be used only once in the future and causes them to be evicted from the cache after the first use (most recently used data to be evicted).</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>    <span class="comment">//    exclusive hint (E) — renders the cache line on the current core in the “exclusive” state, where the cache lines on other cores are invalidated.</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>    <span class="comment">//The combination of temporality, exclusiveness, and locality (L1 or L2) together yields 8 types of instructions supported by the present-day Knights Corner MIC. They specify how the data are expected to be uniquely handled in the cache, enumerated below.</span></div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>    <span class="comment">//instruction   hint    purpose</span></div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>    <span class="comment">//vprefetchnta  _MM_HINT_NTA    loads data to L1 and L2 cache, marks it as NTA</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>    <span class="comment">//vprefetch0    _MM_HINT_T0     loads data to L1 and L2 cache</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>    <span class="comment">//vprefetch1    _MM_HINT_T1     loads data to L2 cache only</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>    <span class="comment">//vprefetch2    _MM_HINT_T2     loads data to L2 cache only, marks it as NTA This mnemonic is counter-intuitive as there is not NTA in it</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>    <span class="comment">//vprefetchenta     _MM_HINT_ENTA   exclusive version of vprefetchnta</span></div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>    <span class="comment">//vprefetche0   _MM_HINT_ET0    exclusive version of vprefetch0</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>    <span class="comment">//vprefetche1   _MM_HINT_ET1    exclusive version of vprefetch1</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>    <span class="comment">//vprefetche2   _MM_HINT_ET2    exclusive version of vprefetch2</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>    <span class="comment">//Note L2 cache of the MIC is inclusive in the sense that it has a copy of all the data in L1.</span></div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>    <span class="comment">//There are two ways of implementing prefetch in C — intrinsic and assembly.</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span><span class="comment"></span>    <span class="comment">//_mm_prefetch((const char*)addr, hint);</span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span><span class="comment"></span>    <span class="comment">//asm volatile (&quot;prefetch_inst [%0]&quot;::&quot;m&quot;(addr));</span></div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>    <span class="comment">//</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>    <span class="comment">//Here addr is the address of the byte starting from which to prefetch, prefetch_inst is the prefetch instructions listed above, and hint is the parameter for the compiler intrinsic. We would like to emphasize again that _MM_HINT_T2 and _MM_HINT_ET2 are counter-intuitive. In fact they are misnomers as both are non-temporary. They should have been named as _MM_HINT_NTA2 and _MM_HINT_ENTA2 by Intel.</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span> </div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span><span class="comment">// Prefetching on Xeons features much fewer hints, apparently! (same link):</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>    <span class="comment">//prefetchnta   _MM_HINT_NTA    loads data to L2 and L3 cache, marks as NTA</span></div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>    <span class="comment">//prefetcht0    _MM_HINT_T0     loads data to L2 and L3 cache</span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>    <span class="comment">//prefetcht1    _MM_HINT_T1     equivalent to prefetch0</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>    <span class="comment">//prefetcht2    _MM_HINT_T2     equivalent to prefetch0</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span> </div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span><span class="keyword">template</span>&lt;<span class="keyword">class</span> T, <span class="keywordtype">size_t</span> alignment = CACHE_LINE_SIZE&gt;</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno"><a class="line" href="classAlignedArray.html">   75</a></span><span class="keyword">class </span><a class="code hl_class" href="classAlignedArray.html">AlignedArray</a> {</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span><span class="keyword">public</span>:</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno"><a class="line" href="classAlignedArray.html#af68b542425051972d9cd4d6cfbefe7d5">   80</a></span>    <a class="code hl_function" href="classAlignedArray.html#af68b542425051972d9cd4d6cfbefe7d5">AlignedArray</a>() :</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>            _vec(0) {</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>    }</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span> </div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno"><a class="line" href="classAlignedArray.html#a8380a7c53e3fd375047c7549b6b81a60">   87</a></span>    <a class="code hl_function" href="classAlignedArray.html#a8380a7c53e3fd375047c7549b6b81a60">AlignedArray</a>(<span class="keywordtype">size_t</span> n) :</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>            _vec(n) {</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>    }</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span> </div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno"><a class="line" href="classAlignedArray.html#a315d6c81e636e4dbc426181f815f53b0">   94</a></span>    <a class="code hl_function" href="classAlignedArray.html#a315d6c81e636e4dbc426181f815f53b0">AlignedArray</a>(<span class="keyword">const</span> <a class="code hl_class" href="classAlignedArray.html">AlignedArray</a> &amp; a) :</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>            _vec(a._vec) {</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>    }</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span> </div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno"><a class="line" href="classAlignedArray.html#a4a3851d8133bf0c74d7eaf9d028fb6a6">  101</a></span>    <a class="code hl_class" href="classAlignedArray.html">AlignedArray</a> &amp; <a class="code hl_function" href="classAlignedArray.html#a4a3851d8133bf0c74d7eaf9d028fb6a6">operator=</a>(<span class="keyword">const</span> <a class="code hl_class" href="classAlignedArray.html">AlignedArray</a> &amp; a) {</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>        _vec = a._vec;</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>        <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>    }</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span> </div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno"><a class="line" href="classAlignedArray.html#afd3b64f711e86c3b0fc68ac5cdf5ffc0">  109</a></span>    <span class="keyword">virtual</span> <a class="code hl_function" href="classAlignedArray.html#afd3b64f711e86c3b0fc68ac5cdf5ffc0">~AlignedArray</a>() {</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>    }</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span> </div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span><span class="preprocessor">#if defined(__SSE3__) or defined(__MIC__)</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> prefetch(<span class="keywordtype">int</span> <span class="comment">/*hint*/</span> = 1, <span class="keywordtype">int</span> n = -1)<span class="keyword"> const </span>{</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>        mardyn_assert(n &gt;= -2);</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span> </div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>        <span class="keywordtype">size_t</span> endPrefetch;</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>        <span class="keyword">const</span> <span class="keywordtype">size_t</span> stride = _round_up(1);</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span> </div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>        <span class="keywordflow">switch</span>(n) {</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>        <span class="keywordflow">case</span> -1:</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>            <span class="comment">// prefetch all up to capacity()</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>            endPrefetch = _vec.capacity();</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>        <span class="keywordflow">case</span> -2:</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>            <span class="comment">// prefetch all up to size()</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>            endPrefetch = _vec.size();</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>            <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>        <span class="keywordflow">default</span>:</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>            <span class="comment">// prefetch only first n elements</span></div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>            endPrefetch = <span class="keyword">static_cast&lt;</span><span class="keywordtype">size_t</span><span class="keyword">&gt;</span>(n);</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>        }</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span> </div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; endPrefetch; i+= stride) {</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>            <span class="keyword">const</span> T &amp; val = _vec[i];</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>            <span class="keyword">const</span> T * valP = &amp;val;</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span><span class="preprocessor">#if defined(__MIC__)</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>            _mm_prefetch((<span class="keyword">const</span> <span class="keywordtype">char</span>*)valP, 2);</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>            _mm_prefetch((<span class="keyword">const</span> <span class="keywordtype">char</span>*)valP, _MM_HINT_T1);</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>        }</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>    }</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> prefetch(<span class="keywordtype">int</span> <span class="comment">/*hint = 1*/</span>, <span class="keywordtype">int</span> <span class="comment">/*n = -1*/</span>)<span class="keyword"> const </span>{}</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span> </div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> increaseStorage(<span class="keywordtype">size_t</span> oldNumElements, <span class="keywordtype">size_t</span> additionalElements) {</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>        mardyn_assert(oldNumElements &lt;= _vec.capacity());</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span> </div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>        <span class="keywordtype">size_t</span> newNumElements = oldNumElements + additionalElements;</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span> </div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>        <span class="keywordflow">if</span> (newNumElements &lt;= _vec.capacity()) {</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>            <span class="comment">// no need to resize</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>            <span class="keywordflow">return</span>;</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>        }</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span> </div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>        <span class="comment">// we need to resize, but also keep contents</span></div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>        _vec.reserve(_round_up(newNumElements));</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>        _vec.resize(_vec.capacity());</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>    }</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span> </div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>    <span class="keywordtype">void</span> appendValue(T v, <span class="keywordtype">size_t</span> oldNumElements) {</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>        increaseStorage(oldNumElements, 1);</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span> </div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>        _vec[oldNumElements] = v;</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>    }</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span> </div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>    <span class="keyword">virtual</span> <span class="keywordtype">size_t</span> resize_zero_shrink(<span class="keywordtype">size_t</span> exact_size, <span class="keywordtype">bool</span> zero_rest_of_CL =</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>            <span class="keyword">false</span>, <span class="keywordtype">bool</span> allow_shrink = <span class="keyword">false</span>) {</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>        <span class="keywordtype">size_t</span> size_rounded_up = _round_up(exact_size);</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span> </div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>        <span class="keywordtype">bool</span> need_resize = size_rounded_up &gt; _vec.size()</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>                or (allow_shrink and size_rounded_up &lt; _vec.size());</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span> </div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>        <span class="keywordflow">if</span> (need_resize) {</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>            _vec.reserve(size_rounded_up);</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>            _vec.resize(_vec.capacity());</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>        }</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>        <span class="comment">// we might still need to zero the rest of the Cache Line</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>        <span class="keywordflow">if</span> (zero_rest_of_CL and size_rounded_up &gt; 0) {</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>            std::memset(_vec.data() + exact_size, 0,</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>                    size_rounded_up - exact_size);</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>        }</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span> </div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>        mardyn_assert(size_rounded_up &lt;= _vec.size());</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>        <span class="keywordflow">return</span> _vec.size();</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>    }</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span> </div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno"><a class="line" href="classAlignedArray.html#acc7558483f7454c95a0d7109715f239e">  192</a></span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="classAlignedArray.html#acc7558483f7454c95a0d7109715f239e">resize</a>(<span class="keywordtype">size_t</span> n) {</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>        _vec.reserve(_round_up(n));</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>        _vec.resize(_vec.capacity());</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>    }</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span> </div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>    <span class="keyword">virtual</span> <span class="keywordtype">void</span> zero(<span class="keywordtype">size_t</span> start_idx = 0) {</div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>        <span class="keywordflow">if</span> (_vec.size() &gt; 0 and start_idx &lt; _vec.capacity()) {</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>            <span class="keywordtype">size_t</span> num_to_zero = _vec.capacity() - start_idx;</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>            std::memset(_vec.data() + start_idx, 0, num_to_zero * <span class="keyword">sizeof</span>(T));</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>        }</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>    }</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span> </div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno"><a class="line" href="classAlignedArray.html#a69301d4dee4f92b26eb5561f11657b85">  207</a></span>    <span class="keyword">inline</span> <span class="keywordtype">size_t</span> <a class="code hl_function" href="classAlignedArray.html#a69301d4dee4f92b26eb5561f11657b85">get_size</a>()<span class="keyword"> const </span>{</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>        <span class="keywordflow">return</span> _vec.size();</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>    }</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span> </div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno"><a class="line" href="classAlignedArray.html#a86f379ed07dafbd068999f67fbd7b773">  214</a></span>    <span class="keyword">operator</span> T*() {</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>        <span class="keywordflow">return</span> _vec.data();</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>    }</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span> </div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>    <span class="keyword">operator</span> <span class="keyword">const</span> T*() <span class="keyword">const</span> {</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>        <span class="keywordflow">return</span> _vec.data();</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>    }</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span> </div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno"><a class="line" href="classAlignedArray.html#a80a9c4688800d6264ee044de6c161688">  225</a></span>    <span class="keywordtype">size_t</span> <a class="code hl_function" href="classAlignedArray.html#a80a9c4688800d6264ee044de6c161688">get_dynamic_memory</a>()<span class="keyword"> const </span>{</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>        <span class="keywordflow">return</span> _vec.capacity() * <span class="keyword">sizeof</span>(T);</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>    }</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span> </div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>    <span class="keyword">static</span> <span class="keywordtype">size_t</span> _round_up(<span class="keywordtype">size_t</span> n) {</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> j = alignment / <span class="keyword">sizeof</span>(T) - 1;</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ret = (n + j) &amp; ~j;</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>        <span class="keywordflow">return</span> ret;</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span>    }</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span> </div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span><span class="keyword">protected</span>:</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span> </div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>    std::vector&lt;T, AlignedAllocator&lt;T, alignment&gt;&gt; _vec;</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span> </div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>};</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span> </div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span> </div>
<div class="ttc" id="aclassAlignedArray_html"><div class="ttname"><a href="classAlignedArray.html">AlignedArray</a></div><div class="ttdoc">An aligned array.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:75</div></div>
<div class="ttc" id="aclassAlignedArray_html_a315d6c81e636e4dbc426181f815f53b0"><div class="ttname"><a href="classAlignedArray.html#a315d6c81e636e4dbc426181f815f53b0">AlignedArray::AlignedArray</a></div><div class="ttdeci">AlignedArray(const AlignedArray &amp;a)</div><div class="ttdoc">Construct a copy of another AlignedArray.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:94</div></div>
<div class="ttc" id="aclassAlignedArray_html_a4a3851d8133bf0c74d7eaf9d028fb6a6"><div class="ttname"><a href="classAlignedArray.html#a4a3851d8133bf0c74d7eaf9d028fb6a6">AlignedArray::operator=</a></div><div class="ttdeci">AlignedArray &amp; operator=(const AlignedArray &amp;a)</div><div class="ttdoc">Assign a copy of another AlignedArray.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:101</div></div>
<div class="ttc" id="aclassAlignedArray_html_a69301d4dee4f92b26eb5561f11657b85"><div class="ttname"><a href="classAlignedArray.html#a69301d4dee4f92b26eb5561f11657b85">AlignedArray::get_size</a></div><div class="ttdeci">size_t get_size() const</div><div class="ttdoc">Return current size in terms of elements.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:207</div></div>
<div class="ttc" id="aclassAlignedArray_html_a80a9c4688800d6264ee044de6c161688"><div class="ttname"><a href="classAlignedArray.html#a80a9c4688800d6264ee044de6c161688">AlignedArray::get_dynamic_memory</a></div><div class="ttdeci">size_t get_dynamic_memory() const</div><div class="ttdoc">Return amount of allocated storage + .</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:225</div></div>
<div class="ttc" id="aclassAlignedArray_html_a8380a7c53e3fd375047c7549b6b81a60"><div class="ttname"><a href="classAlignedArray.html#a8380a7c53e3fd375047c7549b6b81a60">AlignedArray::AlignedArray</a></div><div class="ttdeci">AlignedArray(size_t n)</div><div class="ttdoc">Construct an array of n elements.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:87</div></div>
<div class="ttc" id="aclassAlignedArray_html_acc7558483f7454c95a0d7109715f239e"><div class="ttname"><a href="classAlignedArray.html#acc7558483f7454c95a0d7109715f239e">AlignedArray::resize</a></div><div class="ttdeci">virtual void resize(size_t n)</div><div class="ttdoc">Reallocate the array. All content may be lost.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:192</div></div>
<div class="ttc" id="aclassAlignedArray_html_af68b542425051972d9cd4d6cfbefe7d5"><div class="ttname"><a href="classAlignedArray.html#af68b542425051972d9cd4d6cfbefe7d5">AlignedArray::AlignedArray</a></div><div class="ttdeci">AlignedArray()</div><div class="ttdoc">Construct an empty array.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:80</div></div>
<div class="ttc" id="aclassAlignedArray_html_afd3b64f711e86c3b0fc68ac5cdf5ffc0"><div class="ttname"><a href="classAlignedArray.html#afd3b64f711e86c3b0fc68ac5cdf5ffc0">AlignedArray::~AlignedArray</a></div><div class="ttdeci">virtual ~AlignedArray()</div><div class="ttdoc">Free the array.</div><div class="ttdef"><b>Definition:</b> AlignedArray.h:109</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Sep 24 2024 20:06:34 for ls1-MarDyn by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
